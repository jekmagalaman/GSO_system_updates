{% extends "unit_heads/unit_head_base_dashboard.html" %}

{% block title %}Request #{{ req.id }}{% endblock %}

{% block main_content %}
<div class="header d-flex align-items-center justify-content-between mb-3">
  <h1 class="page-title">REQUEST DETAILS</h1>
  <a href="{% url 'unit_head_request_management' %}" class="btn btn-secondary btn-sm">‚Üê Back</a>
</div>

<div class="card p-3 shadow-sm mb-4">
  <h4 class="mb-3">Request Information</h4>
  <div class="row g-3">
    <div class="col-md-6">
      <p><strong>Request ID:</strong> {{ req.id }}</p>
      <p><strong>Requesting Office:</strong> {{ req.requestor.get_full_name|default:req.requestor.username }}</p>
      <p><strong>Type:</strong> {{ req.get_unit_display }}</p>
    </div>
    <div class="col-md-6">
      <p><strong>Date Submitted:</strong> {{ req.created_at|date:"Y-m-d H:i" }}</p>
      <p>
        <strong>Status:</strong>
        {% if req.status == "Pending" %}
          <span class="status-badge status-pending">‚óè Pending</span>
        {% elif req.status == "Approved" %}
          <span class="status-badge status-approved">‚óè Approved</span>
        {% elif req.status == "Done for Review" %}
          <span class="status-badge status-review">‚óè Done for Review</span>
        {% elif req.status == "Completed" %}
          <span class="status-badge status-completed">‚óè Completed</span>
        {% else %}
          <span class="status-badge">{{ req.status }}</span>
        {% endif %}
      </p>
      <p>
        <strong>Assigned Personnel:</strong>
        {% if req.assigned_personnel.all %}
          {% for p in req.assigned_personnel.all %}
            {{ p.get_full_name|default:p.username }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        {% else %}
          <span class="text-muted">Unassigned</span>
        {% endif %}
      </p>
    </div>
  </div>
</div>

<div class="card p-3 shadow-sm mb-4">
  <h4 class="mb-3">Assign Personnel</h4>

  {% if req.status == "Done for Review" or req.status == "Completed" %}
    <p class="text-muted">üö´ Personnel assignment is locked because this request is already under review or completed.</p>
  {% else %}
    <form method="post" class="d-flex flex-column gap-3">
      {% csrf_token %}
      <div>
        <label for="personnel_id" class="form-label">Select Personnel</label>
        <select name="personnel_ids" id="personnel_id" class="form-select" multiple>
          {% for p in personnel %}
            <option value="{{ p.id }}" {% if p in req.assigned_personnel.all %}selected{% endif %}>
              {{ p.get_full_name|default:p.username }}
            </option>
          {% endfor %}
        </select>
        <small class="text-muted">Hold CTRL to select multiple.</small>
      </div>
      <div>
        <button type="submit" class="btn btn-success">Assign</button>
      </div>
    </form>
  {% endif %}
</div>

{% if req.status == "Done for Review" %}
<div class="card p-3 shadow-sm">
  <h4 class="mb-3">Completion Review</h4>
  <form method="post" action="{% url 'unit_head_request_detail' req.id %}">
    {% csrf_token %}
    <button type="submit" name="approve_done" class="btn btn-success">‚úÖ Approve Completion</button>
    <button type="submit" name="reject_done" class="btn btn-danger">‚ùå Send Back</button>
</form>
</div>
{% endif %}
{% endblock %}
