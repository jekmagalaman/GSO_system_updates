{% extends "unit_heads/unit_head_base_dashboard.html" %}

{% block title %}Request #{{ req.id }}{% endblock %}

{% block main_content %}
<div class="header d-flex align-items-center justify-content-between mb-4">
  <h1 class="page-title">REQUEST DETAILS</h1>
  <a href="{% url 'unit_head_request_management' %}" class="btn btn-secondary btn-sm">
    ← Back to Requests
  </a>
</div>

<!-- Request Information -->
<div class="card p-4 shadow-sm mb-4">
  <h4><b>REQUEST INFORMATION</b></h4>
  <div class="row g-3">
    <div class="col-md-6">
      <p><strong>ID:</strong> #{{ req.id }}</p>
      <p><strong>Requestor:</strong> {{ req.full_name|default:req.requestor.get_full_name|default:req.requestor.username }}</p>
      <p><strong>Office:</strong> {{ req.requestor.get_full_name|default:req.requestor }}</p>
      <p><strong>Type:</strong> {{ req.get_unit_display }}</p>
    </div>
    <div class="col-md-6">
      <p><strong>Date Submitted:</strong> {{ req.created_at|date:"Y-m-d H:i" }}</p>
      <p>
        <strong>Status:</strong>
        {% if req.status == "Pending" %}
          <span class="status-badge status-pending">● Pending</span>
        {% elif req.status == "Approved" %}
          <span class="status-badge status-approved">● Approved</span>
        {% elif req.status == "Done for Review" %}
          <span class="status-badge status-review">● Done for Review</span>
        {% elif req.status == "Completed" %}
          <span class="status-badge status-completed">● Completed</span>
        {% else %}
          <span class="status-badge">{{ req.status }}</span>
        {% endif %}
      </p>
      <p>
        <strong>Assigned Personnel:</strong>
        {% if req.assigned_personnel.all %}
          <span class="badge bg-info text-dark">
            {% for p in req.assigned_personnel.all %}
              {{ p.get_full_name|default:p.username }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </span>
        {% else %}
          <span class="text-muted">Unassigned</span>
        {% endif %}
      </p>
      <p>
        <strong>Assigned Materials:</strong>
        {% if req.requestmaterial_set.all %}
          <ul class="mb-0 ps-3">
            {% for rm in req.requestmaterial_set.all %}
              <li>{{ rm.material.name }} - {{ rm.quantity }} {{ rm.material.unit }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-muted">No materials assigned</span>
        {% endif %}
      </p>
    </div>
  </div>
</div>

{% if req.status != "Completed" and req.status != "Done for Review" %}
  <!-- Assign Personnel -->
  <div class="card p-4 shadow-sm mb-4">
    <h4><b>ASSIGN PERSONNEL</b></h4>
    <form method="post" class="d-flex flex-column gap-3">
      {% csrf_token %}
      <div>
        <label for="personnel_id" class="form-label">Select Personnel</label>
        <select name="personnel_ids" id="personnel_id" class="form-select" multiple>
          {% for p in personnel %}
            <option value="{{ p.id }}" {% if p in req.assigned_personnel.all %}selected{% endif %}>
              {{ p.get_full_name|default:p.username }}
            </option>
          {% endfor %}
        </select>
        <small class="text-muted">Hold CTRL (Windows) or CMD (Mac) to select multiple.</small>
      </div>
      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-success">Submit</button>
      </div>
    </form>
  </div>

  <!-- Assign Materials -->
  <div class="card p-4 shadow-sm mb-4 border-0 rounded-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4><b>SELECT MATERIALS</b></h4>
      <span class="badge bg-light text-dark">
        {{ materials|length }} Materials Available
      </span>
    </div>
  
    <form method="post">
      {% csrf_token %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th style="width: 50px;"></th>
              <th>Material</th>
              <th>Available Stock</th>
              <th style="width: 150px;">Quantity Needed</th>
            </tr>
          </thead>
          <tbody>
            {% for m in materials %}
            <tr>
              <td>
                <input type="checkbox" name="material_ids" value="{{ m.id }}"
                       class="form-check-input"
                       {% if m in req.materials.all %}checked{% endif %}>
              </td>
              <td>
                <strong>{{ m.name }}</strong><br>
                <small class="text-muted">Unit: {{ m.unit }}</small>
              </td>
              <td>
                <span class="badge bg-info text-dark">
                  {{ m.quantity }} {{ m.unit }}
                </span>
              </td>
              <td>
                <input type="number" name="quantity_{{ m.id }}"
                       value="{% for rm in req.requestmaterial_set.all %}{% if rm.material.id == m.id %}{{ rm.quantity }}{% endif %}{% endfor %}"
                       min="1" class="form-control form-control-sm text-center"
                       style="max-width: 100px;">
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted">
                No materials available in inventory.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  
      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-success">
          Submit
        </button>
      </div>
    </form>
  </div>
  
{% endif %}


<!-- Completion Review -->
{% if req.status == "Done for Review" %}
<div class="card p-4 shadow-sm">
  <h4><b>COMPLETION REVIEW</b></h4>
  <form method="post" action="{% url 'unit_head_request_detail' req.id %}">
    {% csrf_token %}
    <button type="submit" name="approve_done" class="btn btn-success me-2">Approve Completion</button>
    <button type="submit" name="reject_done" class="btn btn-danger">Send Back</button>
  </form>
</div>
{% endif %}







{% endblock %}
