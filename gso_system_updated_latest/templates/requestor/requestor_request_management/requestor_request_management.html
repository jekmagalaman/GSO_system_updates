{% extends "requestor/requestor_base_dashboard.html" %}

{% block title %}Request Management{% endblock %}

{% block main_content %}
<!-- Main Content -->
<main class="main-content">
  <div class="request-container">
    <div class="request-header">
      <h2 class="request-title">REQUEST MANAGEMENT</h2>
      <div class="header-actions">
        <button class="add-btn" id="openModal">Add Request</button>
      </div>
    </div>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Job No.</th>
            <th>Unit Name</th>
            <th>Request Date</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for req in requests %}
          <tr>
            <td>{{ req.id }}</td>
            <td>{{ req.get_unit_display }}</td>
            <td>{{ req.created_at|date:"Y-m-d" }}</td>
            <td>
              {% if req.status == "Pending" %}
                <span class="status-badge status-pending">● Pending</span>
              {% elif req.status == "Approved" %}
                <span class="status-badge status-approved">● Approved</span>
              {% elif req.status == "In Progress" %}
                <span class="status-badge status-inprogress">● In Progress</span>
              {% elif req.status == "Completed" %}
                <span class="status-badge status-completed">● Completed</span>
              {% else %}
                <span class="status-badge">{{ req.status }}</span>
              {% endif %}
            </td>
            <td>
              <button class="btn btn-sm btn-primary"
                onclick="openModal('{{ req.id }}','{{ req.get_unit_display }}','{{ req.created_at|date:'Y-m-d' }}','{{ req.status }}','{{ req.description|escapejs }}')">
                View
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center">No requests found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</main>

<!-- Modal 1: Choose Unit -->
<div id="requestModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Select Request Type</h3>
      <span class="close-btn" id="closeModal">&times;</span>
    </div>
    <div class="modal-options">
      <button class="modal-option" data-unit="Maintenance">Maintenance</button>
      <button class="modal-option" data-unit="Utility">Utility</button>
      <button class="modal-option" data-unit="Electrical">Electrical</button>
      <button class="modal-option" data-unit="Motorpool">Motorpool</button>
    </div>
  </div>
</div>

<!-- Modal 2: Review Request Details -->
<div id="formModal2" class="modal2">
  <div class="modal2-content">
    <div class="modal2-header">
      <div class="modal2-header-left">
        <span class="modal2-back-btn" id="backToModal1">&#8592;</span>
        <h2 class="modal2-title" id="formTitle">Review Request Details!</h2>
      </div>
      <button class="modal2-close-btn" onclick="closeModal2()">&times;</button>
    </div>

    <!-- FORM START -->
    <form method="POST" action="{% url 'add_request' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal2-body">
        <!-- Hidden Unit -->
        <input type="hidden" name="unit" id="selectedUnit">

        <!-- Category Selection -->
        <div class="modal2-category-section">
          <label class="modal2-category-label">PLEASE CHECK THE APPROPRIATE BOX</label>
          <div class="modal2-checkbox-group">
            <label><input type="checkbox" name="labor" value="1"> LABOR</label>
            <label><input type="checkbox" name="materials" value="1"> MATERIALS</label>
            <label><input type="checkbox" name="others" value="1"> OTHERS</label>
          </div>
        </div>

        <!-- Requestor Information -->
        <div class="modal2-section">
          <h3 class="modal2-section-title">Requestor Information</h3>
          <div class="modal2-grid">
            <input type="text" class="modal2-input" name="full_name" placeholder="Full Name*" required>
            <input type="text" class="modal2-input" name="department" placeholder="Department/Office*" required>
            <input type="email" class="modal2-input" name="email" placeholder="Email*" required>
            <input type="tel" class="modal2-input" name="contact_number" placeholder="Contact Number*" required>
          </div>
        </div>

        <!-- Requestor Details -->
        <div class="modal2-section">
          <h3 class="modal2-section-title">Request Details</h3>
          <textarea class="modal2-textarea" name="description" placeholder="Detailed Description*" required></textarea>
        </div>

        <!-- Attachments -->
        <div class="modal2-attachments">
          <label class="modal2-label">Attachments</label>
          <input type="file" name="attachment" accept="image/*">
        </div>

        <!-- Submit -->
        <div class="modal2-confirm">
          <button type="submit" class="modal2-confirm-btn">Submit Request</button>
        </div>
      </div>
    </form>
    <!-- FORM END -->
  </div>
</div>

<!-- Modal 3: View Request Details -->
<div id="viewRequestModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Request Details</h3>
      <span class="close-btn" onclick="closeViewModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p><strong>Job No:</strong> <span id="view-id"></span></p>
      <p><strong>Unit:</strong> <span id="view-unit"></span></p>
      <p><strong>Date:</strong> <span id="view-date"></span></p>
      <p><strong>Status:</strong> <span id="view-status"></span></p>
      <p><strong>Description:</strong></p>
      <p id="view-description"></p>
    </div>
  </div>
</div>

<script>
  // Modal 1
  const modal = document.getElementById("requestModal");
  document.getElementById("openModal").onclick = () => modal.style.display = "flex";
  document.getElementById("closeModal").onclick = () => modal.style.display = "none";

  // Modal 2
  const formModal2 = document.getElementById("formModal2");
  const backToModal1 = document.getElementById("backToModal1");
  const formTitle = document.getElementById("formTitle");

  document.querySelectorAll(".modal-option").forEach(option => {
    option.addEventListener("click", () => {
      const unit = option.getAttribute("data-unit");
      formTitle.textContent = unit + " Request Details";
      document.getElementById("selectedUnit").value = unit;
      modal.style.display = "none";
      formModal2.style.display = "flex";
    });
  });

  backToModal1.onclick = () => {
    formModal2.style.display = "none";
    modal.style.display = "flex";
  };

  function closeModal2() {
    formModal2.style.display = "none";
  }

  // Modal 3 (View)
  function openModal(id, unit, date, status, description) {
    document.getElementById("view-id").textContent = id;
    document.getElementById("view-unit").textContent = unit;
    document.getElementById("view-date").textContent = date;
    document.getElementById("view-status").textContent = status;
    document.getElementById("view-description").textContent = description;
    document.getElementById("viewRequestModal").style.display = "flex";
  }

  function closeViewModal() {
    document.getElementById("viewRequestModal").style.display = "none";
  }
</script>

{% endblock %}
