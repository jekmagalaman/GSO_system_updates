{% extends "requestor/requestor_base_dashboard.html" %}

{% block title %}Request Management{% endblock %}

{% block main_content %}
<!-- Main Content -->
<main class="main-content">
  <div class="request-container">
    <div class="request-header">
      <h2 class="request-title">REQUEST MANAGEMENT</h2>
      <div class="header-actions">
        <button class="add-btn" id="openModal">Add Request</button>
        <button class="refresh-btn">
          <span class="icon icon-refresh"></span>
        </button>
      </div>
    </div>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Job No.</th>
            <th>Unit Name</th>
            <th>Request Date</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for req in requests %}
          <tr>
            <td>{{ req.id }}</td>
            <td>{{ req.get_unit_display }}</td>
            <td>{{ req.created_at|date:"Y-m-d" }}</td>
            <td>
              {% if req.status == "Pending" %}
                <span class="status-badge status-pending">● Pending</span>
              {% elif req.status == "In Progress" %}
                <span class="status-badge status-inprogress">● In Progress</span>
              {% elif req.status == "Completed" %}
                <span class="status-badge status-completed">● Completed</span>
              {% else %}
                <span class="status-badge">{{ req.status }}</span>
              {% endif %}
            </td>
            <td>
              <button class="btn btn-sm btn-primary"
                onclick="openModal('{{ req.id }}','{{ req.get_unit_display }}','{{ req.created_at|date:'Y-m-d' }}','{{ req.status }}','{{ req.description|escapejs }}')">
                View
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center">No requests found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</main>


<!-- Modal 1: Choose Unit -->
<div id="requestModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Select Request Type</h3>
      <span class="close-btn" id="closeModal">&times;</span>
    </div>
    <div class="modal-options">
      <button class="modal-option" data-unit="Repair and Maintenance">Maintenance</button>
      <button class="modal-option" data-unit="Utility">Utility</button>
      <button class="modal-option" data-unit="Electrical">Electrical</button>
      <button class="modal-option" data-unit="Motorpool">Motorpool</button>
    </div>
  </div>
</div>

<!-- Modal 2: Review Request Details -->
<div id="formModal2" class="modal2">
  <div class="modal2-content">
    <div class="modal2-header">
      <div class="modal2-header-left">
        <span class="modal2-back-btn" id="backToModal1">&#8592;</span>
        <h2 class="modal2-title" id="formTitle">Review Request Details!</h2>
      </div>
      <button class="modal2-close-btn" onclick="closeModal2()">&times;</button>
    </div>

    <!-- FORM START -->
    <form method="POST" action="{% url 'add_request' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal2-body">

        <!-- Category Selection -->
        <div class="modal2-category-section">
          <label class="modal2-category-label">PLEASE CHECK THE APPROPRIATE BOX</label>
          <div class="modal2-checkbox-group">
            <div class="modal2-checkbox-item">

              <input type="hidden" name="unit" id="selectedUnit">

              <input type="checkbox" name="labor" id="labor" value="1">
              <label for="labor">LABOR</label>
            </div>
            <div class="modal2-checkbox-item">
              <input type="checkbox" name="materials" id="materials" value="1">
              <label for="materials">MATERIALS</label>
            </div>
            <div class="modal2-checkbox-item">
              <input type="checkbox" name="others" id="others" value="1">
              <label for="others">OTHERS</label>
            </div>
          </div>
        </div>

        <!-- Requestor Information -->
        <div class="modal2-section">
          <h3 class="modal2-section-title">Requestor Information</h3>
          <div class="modal2-grid">
            <div class="modal2-group">
              <label class="modal2-label">Last Name*</label>
              <input type="text" class="modal2-input" name="last_name" required>
            </div>
            <div class="modal2-group">
              <label class="modal2-label">First Name*</label>
              <input type="text" class="modal2-input" name="first_name" required>
            </div>
            <div class="modal2-group">
              <label class="modal2-label">Middle Initial</label>
              <input type="text" class="modal2-input" name="middle_name">
            </div>
          </div>
          <div class="modal2-grid">
            <div class="modal2-group">
              <label class="modal2-label">Department/Office*</label>
              <input type="text" class="modal2-input" name="department" required>
            </div>
            <div class="modal2-group">
              <label class="modal2-label">Email Address*</label>
              <input type="email" class="modal2-input" name="email" required>
            </div>
            <div class="modal2-group">
              <label class="modal2-label">Contact Number*</label>
              <input type="tel" class="modal2-input" name="contact_number" required>
            </div>
          </div>
        </div>

        <!-- Requestor Details -->
        <div class="modal2-section">
          <h3 class="modal2-section-title">Requestor Details</h3>
          <div class="modal2-group">
            <label class="modal2-label">Detailed Description of Request*</label>
            <textarea class="modal2-textarea" name="description" required></textarea>
          </div>
        </div>

        <!-- Attachments -->
        <div class="modal2-attachments">
          <label class="modal2-label">Attachments*</label>
          <div class="modal2-attachment-area">
            <input type="file" name="attachment" accept="image/*">
          </div>
        </div>

        <!-- Confirm Button -->
        <div class="modal2-confirm">
          <button type="submit" class="modal2-confirm-btn">Submit Request</button>
        </div>
      </div>
    </form>
    <!-- FORM END -->

  </div>
</div>


<script>
  // First Modal
  const modal = document.getElementById("requestModal");
  const openBtn = document.getElementById("openModal");
  const closeBtn = document.getElementById("closeModal");

  openBtn.onclick = () => modal.style.display = "flex";
  closeBtn.onclick = () => modal.style.display = "none";

  // Second Modal (Review Request)
  const formModal2 = document.getElementById("formModal2");
  const backToModal1 = document.getElementById("backToModal1");
  const formTitle = document.getElementById("formTitle");

  // Open Modal 2 when choosing request type
  document.querySelectorAll(".modal-option").forEach(option => {
    option.addEventListener("click", () => {
      const unit = option.getAttribute("data-unit");
      formTitle.textContent = unit + " Request Details";
      modal.style.display = "none";
      formModal2.style.display = "flex";
    });
  });

  // Back button to Modal 1
  backToModal1.onclick = () => {
    formModal2.style.display = "none";
    modal.style.display = "flex";
  };

  // Close function for Modal 2
  function closeModal2() {
    formModal2.style.display = "none";
  }

  // Confirm function (example)
  function confirmRequest() {
    alert("Request confirmed!");
    closeModal2();
  }



// Open Modal 2 when choosing request type
document.querySelectorAll(".modal-option").forEach(option => {
  option.addEventListener("click", () => {
    const unit = option.getAttribute("data-unit");

    // Update modal title
    formTitle.textContent = unit + " Request Details";

    // ✅ Set hidden input value
    document.getElementById("selectedUnit").value = unit;

    // Switch modals
    modal.style.display = "none";
    formModal2.style.display = "flex";
  });
});
  
</script>


{% endblock %}
